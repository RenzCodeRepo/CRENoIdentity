@model CRE.ViewModels.ChairpersonApplicationsViewModel

@{
    ViewData["Title"] = "Select Application";
}

<h2>Select Application</h2>

<!-- Tab Navigation -->
<ul class="nav nav-tabs" id="myTab" role="tablist">
    <li class="nav-item" role="presentation">
        <a class="nav-link active" id="unassigned-tab" data-bs-toggle="tab" href="#unassigned" role="tab" aria-controls="unassigned" aria-selected="true">Unassigned Applications</a>
    </li>
    <li class="nav-item" role="presentation">
        <a class="nav-link" id="under-evaluation-tab" data-bs-toggle="tab" href="#under-evaluation" role="tab" aria-controls="under-evaluation" aria-selected="false">Under Evaluation</a>
    </li>
    <li class="nav-item" role="presentation">
        <a class="nav-link" id="evaluation-result-tab" data-bs-toggle="tab" href="#evaluation-result" role="tab" aria-controls="evaluation-result" aria-selected="false">Evaluation Result</a>
    </li>
</ul>

<!-- Tab Content -->
<div class="tab-content" id="myTabContent">
        <!-- Unassigned Applications Tab -->
        <div class="tab-pane fade show active" id="unassigned" role="tabpanel" aria-labelledby="unassigned-tab">
            <h4>Unassigned Applications</h4>
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>UREC No</th>
                        <th>Details</th>
                        <th>Assigned Date</th>
                        <th>Evaluators</th> <!-- New column for Evaluators -->
                    </tr>
                </thead>
                <tbody>
                    @foreach (var application in Model.UnassignedApplications)
                    {
                        <tr>
                        <td>@application.urecNo</td>
                        <td>@application.NonFundedResearchInfo.title</td> <!-- Changed to nonfundedresearchtitle -->
                        <td>
                            @if (application.EthicsEvaluation.Any())
                            {
                                // Assuming you want the assigned date of the first evaluator
                                @foreach (var evaluation in application.EthicsEvaluation)
                                {
                                    <div>@evaluation.startDate?.ToString("MM/dd/yyyy")</div>
                                }
                            }
                            else
                            {
                                <span>No assigned date</span> <!-- Fallback message -->
                            }
                        </td>
                            <td>
                                <a asp-action="AssignEvaluators" asp-route-urecNo="@application.urecNo" class="btn btn-primary">Assign Evaluators</a>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

    <!-- Under Evaluation Tab -->
    <div class="tab-pane fade" id="under-evaluation" role="tabpanel" aria-labelledby="under-evaluation-tab">
        <h4>Under Evaluation</h4>
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>UREC No</th>
                    <th>Details</th>
                    <th>Assigned Date</th>
                    <th>Evaluators</th> <!-- New column for Evaluators -->
                </tr>
            </thead>
            <tbody>
                @if (Model.UnderEvaluationApplications.Any())
                {
                    foreach (var application in Model.UnderEvaluationApplications)
                    {
                        <tr>
                            <td>@application.urecNo</td>
                            <td>
                                <!-- Display the title of the research from NonFundedResearchInfo -->
                                @if (application.NonFundedResearchInfo != null)
                                {
                                    @application.NonFundedResearchInfo.title
                                    // Display the research title
                                }
                                else
                                {
                                    <span>No title available</span> <!-- Fallback message if no title exists -->
                                }
                            </td>
                            <td>
                                @if (application.EthicsEvaluation.Any())
                                {
                                    foreach (var evaluation in application.EthicsEvaluation)
                                    {
                                        <div>@(evaluation.startDate)</div> <!-- Display the assigned date for each evaluator -->
                                    }
                                }
                                else
                                {
                                    <span>No assigned date available</span> <!-- Fallback message if no evaluation exists -->
                                }
                            </td>
                            <td>
                                @if (Model.ApplicationEvaluatorNames.ContainsKey(application.urecNo))
                                {
                                    var evaluatorNames = Model.ApplicationEvaluatorNames[application.urecNo];

                                    // Get the IDs of evaluators who declined this application
                                    var declinedEvaluatorIds = application.EthicsEvaluation
                                    .Where(e => e.evaluationStatus == "Declined")
                                    .Select(e => e.ethicsEvaluatorId) // Assuming you have a property to get evaluator ID
                                    .ToHashSet(); // Use a HashSet for O(1) lookup

                                    // Display only those evaluators who did not decline
                                    foreach (var evaluator in evaluatorNames)
                                    {
                                        if (!declinedEvaluatorIds.Contains(evaluator.ethicsEvaluatorId)) // Assuming evaluator has an EvaluatorId property
                                        {
                                            // Concatenate the evaluator's name
                                            var fullName = $"{evaluator.Faculty.User.fName} {(string.IsNullOrEmpty(evaluator.Faculty.User.mName) ? "" : evaluator.Faculty.User.mName + " ")}{evaluator.Faculty.User.lName}";
                                            <div>@fullName</div>
                                            // Display evaluator's full name
                                        }
                                    }
                                }
                                else
                                {
                                    <span>No evaluators assigned</span> <!-- Fallback message -->
                                }
                            </td>
                        </tr>
                    }
                }
                else
                {
                    <tr>
                        <td colspan="4" class="text-center">No applications are currently under evaluation.</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>



    <!-- Evaluation Result Tab -->
    <div class="tab-pane fade" id="evaluation-result" role="tabpanel" aria-labelledby="evaluation-result-tab">
        <h4>Evaluation Result</h4>
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>UREC No</th>
                    <th>Submission Date</th>
                    <th>Field of Study</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                @foreach (var application in Model.EvaluationResultApplications)
                {
                    <tr>
                        <td>@application.urecNo</td>
                        <td>@application.submissionDate</td>
                        <td>@application.fieldOfStudy</td>
                        <td>
                            <!-- You can add a button here to view the evaluation results if needed -->
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>
