@model CRE.ViewModels.ApplicationEvaluationViewModel

<h2>Ethics Applications</h2>

<!-- Tabs Navigation -->
<ul class="nav nav-tabs" id="myTab" role="tablist">
    <li class="nav-item">
        <a class="nav-link active" id="exempt-tab" data-toggle="tab" href="#exempt" role="tab" aria-controls="exempt" aria-selected="true">Pending Exempt Evaluations</a>
    </li>
    <li class="nav-item">
        <a class="nav-link" id="evaluated-exempt-tab" data-toggle="tab" href="#evaluated-exempt" role="tab" aria-controls="evaluated-exempt" aria-selected="false">Evaluated Exempt Applications</a>
    </li>
    <li class="nav-item">
        <a class="nav-link" id="evaluated-expedited-tab" data-toggle="tab" href="#evaluated-expedited" role="tab" aria-controls="evaluated-expedited" aria-selected="false">Evaluated Expedited Applications</a>
    </li>
    <li class="nav-item">
        <a class="nav-link" id="evaluated-full-review-tab" data-toggle="tab" href="#evaluated-full-review" role="tab" aria-controls="evaluated-full-review" aria-selected="false">Evaluated Full Review Applications</a>
    </li>
    @* Pending Issuance *@
</ul>

<!-- Tab Content -->
<div class="tab-content mt-3" id="myTabContent">
    <!-- Exempt Applications Tab -->
    <div class="tab-pane fade show active" id="exempt" role="tabpanel" aria-labelledby="exempt-tab">
        <!-- Pending Exempt Applications Table -->
        <table class="table table-bordered">
            <!-- Table Header -->
            <thead>
                <tr>
                    <th>UREC No</th>
                    <th>Title of the Research</th>
                    <th>Proponents/ Authors</th>
                    <th>Start Date</th>
                    <th>Status</th>
                    <th>End Date</th>
                </tr>
            </thead>
            <!-- Table Body -->
            <tbody>
                @if (Model.ExemptApplications == null || !Model.ExemptApplications.Any())
                {
                    <tr>
                        <td colspan="6" class="text-center">No exempt applications found.</td>
                    </tr>
                }
                else
                {
                    foreach (var application in Model.ExemptApplications)
                    {
                        <tr>
                            <td>
                                <a asp-controller="Chief" asp-action="EvaluateApplication" asp-route-urecNo="@application.EthicsApplication?.urecNo" class="btn btn-primary">
                                    @application.EthicsApplication?.urecNo
                                </a>
                            </td>
                            <td>@application.NonFundedResearchInfo?.title</td>
                             <td>
                                @if (application.NonFundedResearchInfo != null && application.NonFundedResearchInfo.AppUser != null)
                                {
                                    @application.NonFundedResearchInfo.AppUser.fName @application.NonFundedResearchInfo.AppUser.lName
                                }
                                else
                                {
                                    <span>No applicant information available</span>
                                }
                                <br />

                                @if (application.NonFundedResearchInfo?.CoProponent != null)
                                {
                                    foreach (var coproponent in application.NonFundedResearchInfo.CoProponent)
                                    {
                                        <span>@coproponent.coProponentName</span>
                                        <br />
                                    }
                                }
                              </td>
                            <td>Pending Evaluation</td>
                            <td>@application.EthicsApplicationLog?.LastOrDefault()?.status</td>
                            <td>Pending Evaluation</td>
                        </tr>
                    }
                }
            </tbody> 
        </table>
    </div>

    <!-- Evaluated Exempt Applications Tab -->
    <div class="tab-pane fade" id="evaluated-exempt" role="tabpanel" aria-labelledby="evaluated-exempt-tab">
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>UREC No</th>
                    <th>Title of the Research</th>
                    <th>Proponents/ Authors</th>
                    <th>Start Date</th>
                    <th>Status</th>
                    <th>End Date</th>
                    <th>Evaluator/s</th> <!-- New column for Evaluator -->
                </tr>
            </thead>
            <tbody>
                @if (Model.EvaluatedExemptApplications == null || !Model.EvaluatedExemptApplications.Any())
                {
                    <tr>
                        <td colspan="7" class="text-center">No evaluated exempt applications found.</td>
                    </tr>
                }
                else
                {
                    @foreach (var application in Model.EvaluatedExemptApplications)
                    {
                        <tr>
                            <td>
                                <a asp-controller="Chief" asp-action="ViewEvaluationDetails" asp-route-urecNo="@application.EthicsApplication.urecNo" asp-route-evaluationId="@application.EthicsEvaluation.evaluationId" class="btn btn-primary">
                                    @application.EthicsApplication.urecNo
                                </a>
                            </td>
                            <td>@application.NonFundedResearchInfo.title</td>
                            <td>
                                <!-- Display main applicant -->
                                @if (application.NonFundedResearchInfo?.AppUser != null)
                                {
                                    @(application.NonFundedResearchInfo.AppUser.fName + " ")
                                    // Adds space after the first name
                                    @(application.NonFundedResearchInfo.AppUser.mName != null ? application.NonFundedResearchInfo.AppUser.mName + " " : "")
                                    // Middle name with conditional space
                                    @application.NonFundedResearchInfo.AppUser.lName
                                }
                                else
                                {
                                    <span>N/A</span>
                                }
                                <br />

                                <!-- Display coproponents if available -->
                                @if (application.NonFundedResearchInfo?.CoProponent != null && application.NonFundedResearchInfo.CoProponent.Any())
                                {
                                    foreach (var coproponent in application.NonFundedResearchInfo.CoProponent)
                                    {
                                        <span>@coproponent.coProponentName</span>
                                        <br />
                                    }
                                }
                            </td>
                            <td>@application.EthicsEvaluation.startDate</td>
                            <td>@(application.EthicsApplicationLog.FirstOrDefault()?.status ?? "N/A")</td><!-- Handle null gracefully -->
                            <td>@application.EthicsEvaluation.endDate</td>
                            <td>
                                <!-- Display Evaluator's (Chief's) Name -->
                                @if (application.EthicsEvaluation?.Chief != null) // Check if the Chief navigation property is not null
                                {
                                    var chief = application.EthicsEvaluation.Chief; // Get the Chief object directly
                                    if (chief.User != null) // Check if the User is not null
                                    {
                                        @($"{chief.User.fName} {(chief.User.mName != null ? chief.User.mName + " " : "")}{chief.User.lName}")
                                    }
                                    else
                                    {
                                        <span>N/A</span>
                                    }
                                }
                                else
                                {
                                    <span>N/A</span>
                                    // If EthicsEvaluation or Chief is null, display "N/A"
                                }
                            </td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>


    <!-- Evaluated Expedited Applications Tab -->
    <div class="tab-pane fade" id="evaluated-expedited" role="tabpanel" aria-labelledby="evaluated-expedited-tab">
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th rowspan="2">UREC No</th>
                    <th rowspan="2">Title of the Research</th>
                    <th rowspan="2">Proponents/ Authors</th>
                    <th colspan="4">Evaluations</th> <!-- Colspan for evaluation headers -->
                </tr>
                <tr>
                    <th>Start Date</th>
                    <th>Status</th>
                    <th>End Date</th>
                    <th>Evaluators</th>
                </tr>
            </thead>
            <tbody>
                @if (Model.EvaluatedExpeditedApplications == null || !Model.EvaluatedExpeditedApplications.Any())
                {
                    <tr>
                        <td colspan="7" class="text-center">No evaluated expedited applications found.</td>
                    </tr>
                }
                else
                {
                    <!-- Iterate through each application -->
                    @foreach (var application in Model.EvaluatedExpeditedApplications)
                    {
                        // Get evaluations
                        var evaluations = application.EthicsEvaluation;
                        var evalCount = evaluations != null ? evaluations.Count() : 0;

                        if (evalCount > 0)
                        {
                            // Track the first evaluation for displaying application details
                            bool isFirstEvaluation = true;

                            foreach (var evaluation in evaluations)
                            {
                                <tr>
                                    @if (isFirstEvaluation)
                                    {
                                        <td>@application.EthicsApplication.urecNo</td>
                                        <td>@application.NonFundedResearchInfo.title</td>
                                        <td>
                                            <!-- Display main applicant -->
                                            @if (application.NonFundedResearchInfo?.AppUser != null)
                                            {
                                                @(application.NonFundedResearchInfo.AppUser.fName + " ")
                                                @(application.NonFundedResearchInfo.AppUser.mName != null ? application.NonFundedResearchInfo.AppUser.mName + " " : "")
                                                @application.NonFundedResearchInfo.AppUser.lName
                                            }
                                            else
                                            {
                                                <span>N/A</span>
                                            }
                                            <br />

                                            <!-- Display coproponents if available -->
                                            @if (application.NonFundedResearchInfo?.CoProponent != null && application.NonFundedResearchInfo.CoProponent.Any())
                                            {
                                                foreach (var coproponent in application.NonFundedResearchInfo.CoProponent)
                                                {
                                                    <span>@coproponent.coProponentName</span>
                                                    <br />
                                                }
                                            }
                                        </td>
                                        isFirstEvaluation = false; // Mark that the application details have been displayed
                                    }
                                    else
                                    {
                                        <td colspan="3"></td> <!-- Empty cells for subsequent evaluations -->
                                    }

                                    <!-- Render evaluation details -->
                                    <td>@(evaluation.startDate.HasValue ? evaluation.startDate.Value.ToString("yyyy-MM-dd") : "Pending")</td>
                                    <td>@(application.EthicsApplicationLog.LastOrDefault()?.status ?? "N/A")</td>
                                    <td>@(evaluation.endDate.HasValue ? evaluation.endDate.Value.ToString("yyyy-MM-dd") : "Pending")</td>
                                    <td>
                                        <!-- Display evaluators' names for each evaluation -->
                                        @if (application.EthicsEvaluator != null)
                                        {
                                            <li>
                                                @($"{application.EthicsEvaluator.Faculty.User.fName} {(application.EthicsEvaluator.Faculty.User.mName ?? "")}{application.EthicsEvaluator.Faculty.User.lName}")
                                            </li>
                                        }
                                        else
                                        {
                                            <span>N/A</span> <!-- If no evaluators are available for this evaluation -->
                                        }
                                    </td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr>
                                <td>@application.EthicsApplication.urecNo</td>
                                <td>@application.NonFundedResearchInfo.title</td>
                                <td>
                                    @if (application.NonFundedResearchInfo?.AppUser != null)
                                    {
                                        @(application.NonFundedResearchInfo.AppUser.fName + " ")
                                        @(application.NonFundedResearchInfo.AppUser.mName != null ? application.NonFundedResearchInfo.AppUser.mName + " " : "")
                                        @application.NonFundedResearchInfo.AppUser.lName
                                    }
                                    else
                                    {
                                        <span>N/A</span>
                                    }
                                    <br />
                                    @if (application.NonFundedResearchInfo?.CoProponent != null && application.NonFundedResearchInfo.CoProponent.Any())
                                    {
                                        foreach (var coproponent in application.NonFundedResearchInfo.CoProponent)
                                        {
                                            <span>@coproponent.coProponentName</span>
                                            <br />
                                        }
                                    }
                                </td>
                                <td colspan="4" class="text-center">No evaluations available</td> <!-- Indicate no evaluations -->
                            </tr>
                        }
                    }
                }
            </tbody>
        </table>
    </div>



    <!-- Evaluated Full Review Applications Tab -->
    <div class="tab-pane fade" id="evaluated-full-review" role="tabpanel" aria-labelledby="evaluated-full-review-tab">
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>UREC No</th>
                    <th>Title of the Research</th>
                    <th>Proponents/ Authors</th>
                    <th>Start Date</th>
                    <th>Status</th>
                    <th>End Date</th>
                    <th>Evaluator/s</th> <!-- New column for Evaluator -->
                </tr>
            </thead>
            <tbody>
                @if (Model.EvaluatedFullReviewApplications == null || !Model.EvaluatedFullReviewApplications.Any())
                {
                    <tr>
                        <td colspan="7" class="text-center">No evaluated full review applications found.</td>
                    </tr>
                }
                else
                {
                    @foreach (var application in Model.EvaluatedFullReviewApplications)
                    {
                        <tr>
                            <td>
                                <a asp-controller="Chief" asp-action="Details" asp-route-urecNo="@application.EthicsApplication.urecNo" class="btn btn-primary">
                                    @application.EthicsApplication.urecNo
                                </a>
                            </td>
                            <td>@application.NonFundedResearchInfo.title</td>
                            <td>
                                <!-- Display main applicant -->
                                @if (application.NonFundedResearchInfo?.AppUser != null)
                                {
                                    @application.NonFundedResearchInfo.AppUser.fName @application.NonFundedResearchInfo.AppUser.lName
                                }
                                else
                                {
                                    <span>N/A</span>
                                }
                                <br />

                                <!-- Display coproponents if available -->
                                @if (application.NonFundedResearchInfo?.CoProponent != null && application.NonFundedResearchInfo.CoProponent.Any())
                                {
                                    foreach (var coproponent in application.NonFundedResearchInfo.CoProponent)
                                    {
                                        <span>@coproponent.coProponentName</span>
                                        <br />
                                    }
                                }
                            </td>

                            <!-- Display evaluations with evaluators -->
                            <td colspan="4">
                                @if (application.EthicsEvaluation != null && application.EthicsEvaluation.Any())
                                {
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>Start Date</th>
                                                <th>Status</th>
                                                <th>End Date</th>
                                                <th>Evaluators</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <!-- Loop through each EthicsEvaluation -->
                                            @foreach (var evaluation in application.EthicsEvaluation)
                                            {
                                                <tr>
                                                    <td>@evaluation.startDate</td>
                                                    <td>@(application.EthicsApplicationLog.FirstOrDefault()?.status ?? "N/A")</td>
                                                    <td>@(evaluation.endDate?.ToString("yyyy-MM-dd") ?? "Pending")</td>
                                                    <td>
                                                        <!-- Display evaluators' names for each evaluation -->
                                                        @if (evaluation.EthicsEvaluator != null)
                                                        {
                                                            <ul>
                                                               
                                                                <li>
                                                                    @if (evaluation.EthicsEvaluator?.Faculty.User != null)
                                                                    {
                                                                        @($"{evaluation.EthicsEvaluator.Faculty.User.fName} {(evaluation.EthicsEvaluator.Faculty.User.mName ?? "")} {evaluation.EthicsEvaluator.Faculty.User.lName}")
                                                                    }
                                                                    else
                                                                    {
                                                                        <span>N/A</span>
                                                                    }
                                                                </li>
                                                               
                                                            </ul>
                                                        }
                                                        else
                                                        {
                                                            <span>N/A</span> <!-- If no evaluators are available for this evaluation -->
                                                        }
                                                    </td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                }
                                else
                                {
                                    <span>N/A</span> <!-- If no evaluations available for this application -->
                                }
                            </td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>
</div>


<!-- Success Modal -->
<div class="modal fade" id="evaluationSuccessModal" tabindex="-1" role="dialog" aria-labelledby="evaluationSuccessModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="evaluationSuccessModalLabel">Evaluation Submitted</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                Your evaluation was submitted successfully.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            // Initialize Bootstrap tabs if necessary
            $('#myTab a').on('click', function (e) {
                e.preventDefault();
                $(this).tab('show');
            });

            // Get URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            // Check if 'success' parameter exists and is true
            if (urlParams.get('success') === 'true') {
                // Show the success modal
                $('#evaluationSuccessModal').modal('show');
            }
        });
    </script>
}
